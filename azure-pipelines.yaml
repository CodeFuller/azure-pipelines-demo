pool:
  name: Azure Pipelines
  vmImage: ubuntu-latest

  variables:
  aws.region: us-east-1

stages:
- stage: BuildStage
  displayName: Build Stage
  jobs:
  - job: BuildJob
    displayName: Build Job
    steps:
      # We emulate project build with file copying.
    - powershell: 'Copy-Item "version.txt" -Destination "app-version.txt"'
      displayName: 'Build Project'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Pipeline Artifact'
      inputs:
        targetPath: 'app-version.txt'
        artifact: 'project-binaries'

- stage: DeployStage
  displayName: Deploy Stage
  jobs:
  - job: DeployJob
    displayName: Deploy Job
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Pipeline Artifact'
      inputs:
        artifactName: 'project-binaries'

    # We check for artifacts existence because S3 Upload task will not produce error in case of missing source files.
    - powershell: |
       $FilePath = "./app-version.txt"
       if (-not (Test-Path $FilePath -PathType Leaf)) {
           Write-Error "File $FilePath does not exist"
           exit 1
       }
      displayName: Check Deploy Artifacts

    - task: S3Upload@1
      displayName: 'Deploy to S3'
      inputs:
        awsCredentials: '$(AwsCredentials)'
        bucketName: '$(TargetBucketName)'
        sourceFolder: .
        globExpressions: app-version.txt
        filesAcl: public-read
